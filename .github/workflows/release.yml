name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.1)'
        required: true
        default: '1.0.1'
        type: string

jobs:
  build-jars:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Extract version from tag or input
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/v}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"
        
    - name: Build with Maven
      run: mvn clean package -DskipTests
      
    - name: Verify JAR files
      run: |
        echo "Checking for runnable JAR files..."
        ls -lh DevTools/target/*-runnable.jar || echo "DevTools runnable JAR not found"
        ls -lh JavaFxEditor/target/*-runnable.jar || echo "JavaFxEditor runnable JAR not found"
        
    - name: Rename JAR files
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if [ -f "DevTools/target/DevTools-1.0.0-SNAPSHOT-runnable.jar" ]; then
          mv DevTools/target/DevTools-1.0.0-SNAPSHOT-runnable.jar DevTools/target/DevTools-$VERSION.jar
          echo "Renamed DevTools JAR to DevTools-$VERSION.jar"
        fi
        if [ -f "JavaFxEditor/target/JavaFxEditor-1.0.0-SNAPSHOT-runnable.jar" ]; then
          mv JavaFxEditor/target/JavaFxEditor-1.0.0-SNAPSHOT-runnable.jar JavaFxEditor/target/JavaFxEditor-$VERSION.jar
          echo "Renamed JavaFxEditor JAR to JavaFxEditor-$VERSION.jar"
        fi
        
    - name: Generate SHA256 checksums
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        cd DevTools/target
        if [ -f "DevTools-$VERSION.jar" ]; then
          sha256sum DevTools-$VERSION.jar > DevTools-$VERSION.jar.sha256
          echo "Generated checksum for DevTools-$VERSION.jar"
          cat DevTools-$VERSION.jar.sha256
        fi
        cd ../../JavaFxEditor/target
        if [ -f "JavaFxEditor-$VERSION.jar" ]; then
          sha256sum JavaFxEditor-$VERSION.jar > JavaFxEditor-$VERSION.jar.sha256
          echo "Generated checksum for JavaFxEditor-$VERSION.jar"
          cat JavaFxEditor-$VERSION.jar.sha256
        fi
        
    - name: Create install scripts
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        mkdir -p dist
        
        # Create install.sh for Linux/macOS
        cat > dist/install-$VERSION.sh <<'SCRIPT_EOF'
        #!/bin/bash
        set -e
        
        VERSION="$1"
        if [ -z "$VERSION" ]; then
          VERSION="latest"
        fi
        
        REPO_URL="https://github.com/daichangya/JavaFxDevTools"
        INSTALL_DIR="${HOME}/.local/share/javafxdevtools"
        BIN_DIR="${HOME}/.local/bin"
        
        echo "JavaFxDevTools Installation Script"
        echo "=================================="
        echo ""
        
        # Check Java version
        if ! command -v java &> /dev/null; then
            echo "Error: Java is not installed. Please install JDK 17 or higher."
            exit 1
        fi
        
        JAVA_VERSION=$(java -version 2>&1 | head -n 1 | cut -d'"' -f2 | sed '/^1\./s///' | cut -d'.' -f1)
        if [ "$JAVA_VERSION" -lt 17 ]; then
            echo "Error: Java 17 or higher is required. Found Java $JAVA_VERSION"
            exit 1
        fi
        
        echo "Java version check passed: $(java -version 2>&1 | head -n 1)"
        
        # Create installation directory
        mkdir -p "$INSTALL_DIR"
        mkdir -p "$BIN_DIR"
        
        # Download JAR files
        echo ""
        echo "Downloading DevTools..."
        curl -L -o "$INSTALL_DIR/DevTools-$VERSION.jar" "$REPO_URL/releases/download/v$VERSION/DevTools-$VERSION.jar"
        
        echo "Downloading JavaFxEditor..."
        curl -L -o "$INSTALL_DIR/JavaFxEditor-$VERSION.jar" "$REPO_URL/releases/download/v$VERSION/JavaFxEditor-$VERSION.jar"
        
        # Create launcher scripts
        echo ""
        echo "Creating launcher scripts..."
        
        cat > "$BIN_DIR/devtools" << 'LAUNCHER_EOF'
        #!/bin/bash
        VERSION="$VERSION"
        java -jar "$HOME/.local/share/javafxdevtools/DevTools-$VERSION.jar" "$@"
        LAUNCHER_EOF
        
        cat > "$BIN_DIR/javafxeditor" << 'LAUNCHER_EOF'
        #!/bin/bash
        VERSION="$VERSION"
        java -jar "$HOME/.local/share/javafxdevtools/JavaFxEditor-$VERSION.jar" "$@"
        LAUNCHER_EOF
        
        chmod +x "$BIN_DIR/devtools"
        chmod +x "$BIN_DIR/javafxeditor"
        
        echo ""
        echo "Installation completed!"
        echo ""
        echo "Applications installed to: $INSTALL_DIR"
        echo "Launcher scripts created in: $BIN_DIR"
        echo ""
        echo "To use the applications, ensure $BIN_DIR is in your PATH:"
        echo "  export PATH=\"\$PATH:$BIN_DIR\""
        echo ""
        echo "Then you can run:"
        echo "  devtools"
        echo "  javafxeditor"
        SCRIPT_EOF

        # Create install.bat for Windows
        cat > dist/install-$VERSION.bat <<'BAT_EOF'
        @echo off
        setlocal enabledelayedexpansion
        
        set "VERSION=%~1"
        if "%VERSION%"=="" set "VERSION=latest"
        
        set "REPO_URL=https://github.com/daichangya/JavaFxDevTools"
        set "INSTALL_DIR=%USERPROFILE%\JavaFxDevTools"
        set "BIN_DIR=%USERPROFILE%\JavaFxDevTools\bin"
        
        echo JavaFxDevTools Installation Script
        echo ==================================
        echo.
        
        REM Check Java version
        java -version >nul 2>&1
        if errorlevel 1 (
            echo Error: Java is not installed. Please install JDK 17 or higher.
            pause
            exit /b 1
        )
        
        echo Java version check passed.
        echo.
        
        REM Create installation directory
        if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"
        if not exist "%BIN_DIR%" mkdir "%BIN_DIR%"
        
        REM Download JAR files
        echo Downloading DevTools...
        curl -L -o "%INSTALL_DIR%\DevTools-%VERSION%.jar" "%REPO_URL%/releases/download/v%VERSION%/DevTools-%VERSION%.jar"
        
        echo Downloading JavaFxEditor...
        curl -L -o "%INSTALL_DIR%\JavaFxEditor-%VERSION%.jar" "%REPO_URL%/releases/download/v%VERSION%/JavaFxEditor-%VERSION%.jar"
        
        REM Create launcher scripts
        echo.
        echo Creating launcher scripts...
        
        echo @echo off > "%BIN_DIR%\devtools.bat"
        echo set "VERSION=%VERSION%" >> "%BIN_DIR%\devtools.bat"
        echo java -jar "%INSTALL_DIR%\DevTools-%%VERSION%%.jar" %%* >> "%BIN_DIR%\devtools.bat"
        
        echo @echo off > "%BIN_DIR%\javafxeditor.bat"
        echo set "VERSION=%VERSION%" >> "%BIN_DIR%\javafxeditor.bat"
        echo java -jar "%INSTALL_DIR%\JavaFxEditor-%%VERSION%%.jar" %%* >> "%BIN_DIR%\javafxeditor.bat"
        
        echo.
        echo Installation completed!
        echo.
        echo Applications installed to: %INSTALL_DIR%
        echo Launcher scripts created in: %BIN_DIR%
        echo.
        echo Add %BIN_DIR% to your PATH to use the applications.
        echo.
        pause
        BAT_EOF

        chmod +x dist/install-$VERSION.sh
        echo "Created install scripts"
        
    - name: Test JAR files
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        echo "Testing JAR files..."
        
        # Test DevTools JAR
        if [ -f "DevTools/target/DevTools-$VERSION.jar" ]; then
          echo "Testing DevTools-$VERSION.jar..."
          java -jar DevTools/target/DevTools-$VERSION.jar --version 2>&1 || echo "DevTools JAR is valid (version check may not be supported)"
        fi
        
        # Test JavaFxEditor JAR
        if [ -f "JavaFxEditor/target/JavaFxEditor-$VERSION.jar" ]; then
          echo "Testing JavaFxEditor-$VERSION.jar..."
          java -jar JavaFxEditor/target/JavaFxEditor-$VERSION.jar --version 2>&1 || echo "JavaFxEditor JAR is valid (version check may not be supported)"
        fi
        
    - name: Prepare release assets
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        mkdir -p release-assets
        
        # Copy JAR files
        if [ -f "DevTools/target/DevTools-$VERSION.jar" ]; then
          cp DevTools/target/DevTools-$VERSION.jar release-assets/
          cp DevTools/target/DevTools-$VERSION.jar.sha256 release-assets/
        fi
        
        if [ -f "JavaFxEditor/target/JavaFxEditor-$VERSION.jar" ]; then
          cp JavaFxEditor/target/JavaFxEditor-$VERSION.jar release-assets/
          cp JavaFxEditor/target/JavaFxEditor-$VERSION.jar.sha256 release-assets/
        fi
        
        # Copy install scripts
        if [ -f "dist/install-$VERSION.sh" ]; then
          cp dist/install-$VERSION.sh release-assets/
        fi
        if [ -f "dist/install-$VERSION.bat" ]; then
          cp dist/install-$VERSION.bat release-assets/
        fi
        
        echo "Release assets prepared:"
        ls -lh release-assets/
        
    - name: Upload JARs and scripts to Release
      uses: softprops/action-gh-release@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        files: |
          release-assets/*.jar
          release-assets/*.sha256
          release-assets/*.sh
          release-assets/*.bat
        
    - name: Upload JAR artifacts for native builds
      uses: actions/upload-artifact@v4
      with:
        name: jars-${{ steps.version.outputs.version }}
        path: |
          DevTools/target/DevTools-${{ steps.version.outputs.version }}.jar
          JavaFxEditor/target/JavaFxEditor-${{ steps.version.outputs.version }}.jar
        retention-days: 1

  build-native-packages:
    needs: build-jars
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            pkg-type: deb
            platform-name: linux
          - os: macos-latest
            pkg-type: dmg
            platform-name: macos
          - os: windows-latest
            pkg-type: msi
            platform-name: windows
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Extract version from tag or input
      id: version
      shell: bash
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/v}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"
        
    - name: Download JAR artifacts
      uses: actions/download-artifact@v4
      with:
        name: jars-${{ steps.version.outputs.version }}
        path: .
        
    - name: Install dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y fakeroot dpkg-dev
        
    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # macOS dependencies are usually pre-installed
        echo "macOS dependencies check..."
        
    - name: Prepare JavaFX modules for jpackage
      if: matrix.os == 'macos-latest' || matrix.os == 'ubuntu-latest'
      shell: bash
      timeout-minutes: 10
      run: |
        echo "Preparing JavaFX modules for jpackage..."
        
        JAVAFX_VERSION="17.0.6"
        mkdir -p javafx-sdk/lib
        
        # Detect macOS architecture
        ARCH=$(uname -m)
        if [ "$ARCH" = "arm64" ] || [ "$ARCH" = "aarch64" ]; then
          JAVAFX_ARCH="osx-aarch64"
        else
          JAVAFX_ARCH="osx-x64"
        fi
        
        echo "Detected architecture: $ARCH, using JavaFX: $JAVAFX_ARCH"
        
        # Method 1: Try downloading JavaFX SDK directly (fastest)
        JAVAFX_SDK_URL="https://download2.gluonhq.com/openjfx/$JAVAFX_VERSION/openjfx-${JAVAFX_VERSION}_${JAVAFX_ARCH}_bin-sdk.zip"
        echo "Attempting to download JavaFX SDK from: $JAVAFX_SDK_URL"
        
        if curl -L --connect-timeout 30 --max-time 300 -f -o javafx-sdk.zip "$JAVAFX_SDK_URL" 2>&1 && [ -f javafx-sdk.zip ] && [ -s javafx-sdk.zip ]; then
          echo "Downloaded $(du -h javafx-sdk.zip | cut -f1), verifying..."
          
          if unzip -t javafx-sdk.zip >/dev/null 2>&1; then
            echo "✅ Zip file is valid, extracting..."
            unzip -q javafx-sdk.zip -d javafx-sdk-temp
            # Find the actual SDK directory
            SDK_DIR=$(find javafx-sdk-temp -type d -name "javafx-sdk-*" -o -name "javafx-sdk" | head -1)
            if [ -n "$SDK_DIR" ] && [ -d "$SDK_DIR/lib" ]; then
              cp -r "$SDK_DIR/lib"/* javafx-sdk/lib/ 2>/dev/null || true
              JAVAFX_MODULE_PATH="javafx-sdk/lib"
              echo "✅ Extracted JavaFX SDK to javafx-sdk/lib"
              rm -rf javafx-sdk-temp javafx-sdk.zip 2>/dev/null || true
            else
              echo "⚠️ Could not find SDK lib directory in zip, trying Maven..."
              rm -rf javafx-sdk-temp javafx-sdk.zip 2>/dev/null || true
            fi
          else
            echo "⚠️ Zip file is invalid, trying Maven..."
            rm -f javafx-sdk.zip 2>/dev/null || true
          fi
        else
          echo "⚠️ Failed to download JavaFX SDK zip, trying Maven..."
        fi
        
        # Method 2: Use Maven to download JavaFX JARs (fallback)
        JAR_COUNT=$(ls -1 javafx-sdk/lib/*.jar 2>/dev/null | wc -l | tr -d ' ')
        if [ "$JAR_COUNT" -lt 6 ]; then
          echo "Downloading JavaFX modules from Maven (fallback)..."
        
        MODULES=("controls" "fxml" "graphics" "base" "web" "media")
        SUCCESS_COUNT=0
        
        for module in "${MODULES[@]}"; do
          echo "Downloading javafx-$module (classifier: $MAVEN_CLASSIFIER)..."
          if mvn dependency:copy \
            -Dartifact=org.openjfx:javafx-$module:$JAVAFX_VERSION:jar:$MAVEN_CLASSIFIER \
            -DoutputDirectory=javafx-sdk/lib \
            -Dtransitive=false \
            -q 2>&1; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            echo "✅ Downloaded javafx-$module"
          else
            echo "⚠️ Failed to download javafx-$module with $MAVEN_CLASSIFIER, trying without classifier..."
            # Try without classifier as fallback
            mvn dependency:copy \
              -Dartifact=org.openjfx:javafx-$module:$JAVAFX_VERSION:jar \
              -DoutputDirectory=javafx-sdk/lib \
              -Dtransitive=false \
              -q 2>&1 && SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) || echo "❌ Failed javafx-$module"
          fi
        done
        
        # Final check
        JAR_COUNT=$(ls -1 javafx-sdk/lib/*.jar 2>/dev/null | wc -l | tr -d ' ')
        echo ""
        echo "Download summary: $SUCCESS_COUNT/${#MODULES[@]} modules downloaded, $JAR_COUNT JARs found"
        
        if [ "$JAR_COUNT" -ge 6 ]; then
          echo "✅ Successfully prepared $JAR_COUNT JavaFX JARs"
          JAVAFX_MODULE_PATH="javafx-sdk/lib"
        elif [ "$JAR_COUNT" -gt 0 ]; then
          echo "⚠️ Only found $JAR_COUNT JARs (need 6), but continuing..."
          echo "Note: jpackage may still work if using Fat JAR with embedded JavaFX"
          JAVAFX_MODULE_PATH="javafx-sdk/lib"
        else
          echo "❌ Failed to download any JavaFX modules"
          echo "Attempting to use Maven local repository..."
          # Try to find JavaFX in Maven local repo
          if [ -d "$HOME/.m2/repository/org/openjfx" ]; then
            echo "Found Maven local repository, copying JavaFX modules..."
            find "$HOME/.m2/repository/org/openjfx" -name "javafx-*-$JAVAFX_VERSION*.jar" -type f | \
              grep -E "(mac-aarch64|mac)" | \
              head -6 | \
              xargs -I {} cp {} javafx-sdk/lib/ 2>/dev/null || true
            JAR_COUNT=$(ls -1 javafx-sdk/lib/*.jar 2>/dev/null | wc -l | tr -d ' ')
            if [ "$JAR_COUNT" -gt 0 ]; then
              echo "✅ Copied $JAR_COUNT JARs from Maven local repository"
              JAVAFX_MODULE_PATH="javafx-sdk/lib"
            fi
          fi
          
          if [ "$JAR_COUNT" -eq 0 ]; then
            echo "⚠️ No JavaFX modules found, jpackage will likely fail"
            echo "Continuing anyway to see full error message..."
            JAVAFX_MODULE_PATH="javafx-sdk/lib"
          fi
        fi
        
        echo ""
        echo "JavaFX module path: $JAVAFX_MODULE_PATH"
        echo "JAVAFX_MODULE_PATH=$JAVAFX_MODULE_PATH" >> $GITHUB_ENV
        echo "JAVAFX_MODULES=javafx.controls,javafx.fxml,javafx.graphics,javafx.base,javafx.web,javafx.media" >> $GITHUB_ENV
        
        # Verify JavaFX modules
        if [ -d "$JAVAFX_MODULE_PATH" ] && [ "$JAR_COUNT" -gt 0 ]; then
          echo "JavaFX modules found:"
          ls -lh "$JAVAFX_MODULE_PATH" | head -10
          echo "Total JARs: $JAR_COUNT"
        else
          echo "⚠️ Warning: JavaFX module path is empty or not found"
        fi
        
    - name: Install dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # Windows dependencies are usually pre-installed
        echo "Windows dependencies check..."
        
    - name: Verify downloaded JAR files
      shell: bash
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        echo "=== Verifying downloaded JAR files ==="
        echo "Version: $VERSION"
        echo "Current directory: $(pwd)"
        
        # Artifacts are downloaded maintaining directory structure
        # So files should be at: DevTools/target/DevTools-$VERSION.jar
        echo ""
        echo "Checking for JAR files:"
        
        if [ -f "DevTools/target/DevTools-$VERSION.jar" ]; then
          echo "✅ Found: DevTools/target/DevTools-$VERSION.jar"
          ls -lh DevTools/target/DevTools-$VERSION.jar
        else
          echo "❌ Not found: DevTools/target/DevTools-$VERSION.jar"
          echo "Searching for DevTools JAR files:"
          find . -name "DevTools-*.jar" -type f 2>/dev/null | head -5 || echo "No DevTools JAR files found"
        fi
        
        if [ -f "JavaFxEditor/target/JavaFxEditor-$VERSION.jar" ]; then
          echo "✅ Found: JavaFxEditor/target/JavaFxEditor-$VERSION.jar"
          ls -lh JavaFxEditor/target/JavaFxEditor-$VERSION.jar
        else
          echo "❌ Not found: JavaFxEditor/target/JavaFxEditor-$VERSION.jar"
          echo "Searching for JavaFxEditor JAR files:"
          find . -name "JavaFxEditor-*.jar" -type f 2>/dev/null | head -5 || echo "No JavaFxEditor JAR files found"
        fi
        
        # List all downloaded files
        echo ""
        echo "All files in current directory structure:"
        find . -type f -name "*.jar" 2>/dev/null | head -10 || echo "No JAR files found"
        
    - name: Build native packages
      shell: bash
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        PKG_TYPE="${{ matrix.pkg-type }}"
        PLATFORM="${{ matrix.platform-name }}"
        
        echo "Building native packages for $PLATFORM ($PKG_TYPE)..."
        echo "Platform: ${{ runner.os }}"
        
        # Check if jpackage is available
        if ! command -v jpackage &> /dev/null; then
          echo "⚠️ jpackage not found, skipping native package generation"
          exit 0
        fi
        
        jpackage --version || echo "jpackage version check failed"
        
        mkdir -p release-assets/native-$PLATFORM
        
        # Build DevTools native package
        if [ -f "DevTools/target/DevTools-$VERSION.jar" ]; then
          echo "Creating DevTools-$PLATFORM package ($PKG_TYPE)..."
          echo "JAR file size: $(du -h DevTools/target/DevTools-$VERSION.jar | cut -f1)"
          
          # Check if LICENSE file exists
          LICENSE_ARG=""
          if [ -f "LICENSE" ]; then
            LICENSE_ARG="--license-file LICENSE"
            echo "License file found"
          else
            echo "⚠️ LICENSE file not found, skipping license file"
          fi
          
          # First create app-image, then convert to package
          echo "Step 1: Creating app-image..."
          
          # Debug: List files in input directory
          echo "Files in DevTools/target:"
          ls -lh DevTools/target/ | head -10
          
          # Debug: Check JAR file
          echo "Checking JAR file:"
          jar tf DevTools/target/DevTools-$VERSION.jar | head -5 || echo "Failed to list JAR contents"
          
          # Build jpackage command
          JPACKAGE_CMD="jpackage \
            --input DevTools/target \
            --name DevTools \
            --main-jar DevTools-$VERSION.jar \
            --main-class com.daicy.devtools.TextEditor \
            --type app-image \
            --dest release-assets/native-$PLATFORM \
            --app-version \"$VERSION\" \
            --description \"DevTools - Plugin-based Text Editor\" \
            --vendor \"daichangya\""
          
          # Add license if available
          if [ -n "$LICENSE_ARG" ]; then
            JPACKAGE_CMD="$JPACKAGE_CMD $LICENSE_ARG"
          fi
          
          # Platform specific options
          if [ "$PLATFORM" = "macos" ]; then
            # Disable code signing for testing
            JPACKAGE_CMD="$JPACKAGE_CMD --mac-package-name \"DevTools\" --mac-sign false"
          fi
          
          # Add JavaFX module path and modules if available (for all platforms)
          if [ -n "$JAVAFX_MODULE_PATH" ] && [ -d "$JAVAFX_MODULE_PATH" ]; then
            JPACKAGE_CMD="$JPACKAGE_CMD --module-path \"$JAVAFX_MODULE_PATH\" --add-modules \"$JAVAFX_MODULES\""
            echo "Adding JavaFX modules: $JAVAFX_MODULES"
          else
            echo "⚠️ Warning: JavaFX module path not set, jpackage may fail to find JavaFX modules"
            echo "Note: This might work if using Fat JAR with embedded JavaFX"
          fi
          
          echo "Executing jpackage command..."
          echo "Command: $JPACKAGE_CMD"
          
          # Capture both stdout and stderr, and show errors immediately
          set +e  # Don't exit on error
          JPACKAGE_OUTPUT=$(eval $JPACKAGE_CMD --verbose 2>&1)
          APP_IMAGE_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          echo "jpackage exit code: $APP_IMAGE_EXIT_CODE"
          echo "jpackage output:"
          echo "$JPACKAGE_OUTPUT"
          
          # If failed, show more diagnostic info
          if [ $APP_IMAGE_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "=== jpackage failed, diagnostic information ==="
            echo "Java version:"
            java -version 2>&1
            echo ""
            echo "jpackage version:"
            jpackage --version 2>&1 || echo "jpackage version check failed"
            echo ""
            echo "JAR file info:"
            ls -lh "DevTools/target/DevTools-$VERSION.jar" || echo "JAR file not found"
            echo ""
            echo "JavaFX module path: $JAVAFX_MODULE_PATH"
            if [ -n "$JAVAFX_MODULE_PATH" ] && [ -d "$JAVAFX_MODULE_PATH" ]; then
              echo "JavaFX modules found:"
              ls -lh "$JAVAFX_MODULE_PATH" | head -10
            else
              echo "JavaFX module path not found or empty"
            fi
            echo "=============================================="
          fi
          
          if [ $APP_IMAGE_EXIT_CODE -eq 0 ]; then
            echo "✅ DevTools app-image created successfully"
            
            # Check if app-image was created (macOS uses .app, Linux uses directory)
            APP_IMAGE_PATH=""
            if [ -d "release-assets/native-$PLATFORM/DevTools.app" ]; then
              APP_IMAGE_PATH="release-assets/native-$PLATFORM/DevTools.app"
            elif [ -d "release-assets/native-$PLATFORM/DevTools" ]; then
              APP_IMAGE_PATH="release-assets/native-$PLATFORM/DevTools"
            fi
            
            if [ -n "$APP_IMAGE_PATH" ]; then
              echo "App-image found at: $APP_IMAGE_PATH"
              echo "Converting to $PKG_TYPE..."
              
              # Convert app-image to package
              if [ "$PKG_TYPE" != "app-image" ]; then
                # Build conversion command
                CONVERT_CMD="jpackage \
                  --app-image \"$APP_IMAGE_PATH\" \
                  --type \"$PKG_TYPE\" \
                  --dest release-assets/native-$PLATFORM \
                  --app-version \"$VERSION\""
                
                # macOS specific options for conversion
                if [ "$PLATFORM" = "macos" ]; then
                  CONVERT_CMD="$CONVERT_CMD --mac-sign false"
                fi
                
                echo "Converting app-image to $PKG_TYPE..."
                echo "Command: $CONVERT_CMD"
                
                JPACKAGE_OUTPUT2=$(eval $CONVERT_CMD --verbose 2>&1)
                PACKAGE_EXIT_CODE=$?
                echo "$JPACKAGE_OUTPUT2"
                
                if [ $PACKAGE_EXIT_CODE -eq 0 ]; then
                  echo "✅ DevTools $PKG_TYPE package created successfully"
                else
                  echo "⚠️ Failed to convert app-image to $PKG_TYPE, but app-image is available"
                fi
              fi
            else
              echo "⚠️ App-image directory not found after creation"
            fi
          else
            echo "❌ DevTools app-image creation failed with exit code $APP_IMAGE_EXIT_CODE"
            echo "Full output:"
            echo "$JPACKAGE_OUTPUT"
          fi
        else
          echo "⚠️ DevTools JAR file not found: DevTools/target/DevTools-$VERSION.jar"
        fi
        
        # Build JavaFxEditor native package
        if [ -f "JavaFxEditor/target/JavaFxEditor-$VERSION.jar" ]; then
          echo "Creating JavaFxEditor-$PLATFORM package ($PKG_TYPE)..."
          echo "JAR file size: $(du -h JavaFxEditor/target/JavaFxEditor-$VERSION.jar | cut -f1)"
          
          # Check if LICENSE file exists
          LICENSE_ARG=""
          if [ -f "LICENSE" ]; then
            LICENSE_ARG="--license-file LICENSE"
            echo "License file found"
          else
            echo "⚠️ LICENSE file not found, skipping license file"
          fi
          
          # First create app-image, then convert to package
          echo "Step 1: Creating app-image..."
          
          # Debug: List files in input directory
          echo "Files in JavaFxEditor/target:"
          ls -lh JavaFxEditor/target/ | head -10
          
          # Debug: Check JAR file
          echo "Checking JAR file:"
          jar tf JavaFxEditor/target/JavaFxEditor-$VERSION.jar | head -5 || echo "Failed to list JAR contents"
          
          # Build jpackage command
          JPACKAGE_CMD="jpackage \
            --input JavaFxEditor/target \
            --name JavaFxEditor \
            --main-jar JavaFxEditor-$VERSION.jar \
            --main-class com.daicy.javafxeditor.TestEditor \
            --type app-image \
            --dest release-assets/native-$PLATFORM \
            --app-version \"$VERSION\" \
            --description \"JavaFxEditor - Customizable Code Editor\" \
            --vendor \"daichangya\""
          
          # Add license if available
          if [ -n "$LICENSE_ARG" ]; then
            JPACKAGE_CMD="$JPACKAGE_CMD $LICENSE_ARG"
          fi
          
          # macOS specific options
          if [ "$PLATFORM" = "macos" ]; then
            # Disable code signing for testing
            JPACKAGE_CMD="$JPACKAGE_CMD --mac-package-name \"JavaFxEditor\" --mac-sign false"
            
            # Add JavaFX module path and modules if available
            if [ -n "$JAVAFX_MODULE_PATH" ] && [ -d "$JAVAFX_MODULE_PATH" ]; then
              JPACKAGE_CMD="$JPACKAGE_CMD --module-path \"$JAVAFX_MODULE_PATH\" --add-modules \"$JAVAFX_MODULES\""
              echo "Adding JavaFX modules: $JAVAFX_MODULES"
            else
              echo "⚠️ Warning: JavaFX module path not set, jpackage may fail to find JavaFX modules"
            fi
          fi
          
          echo "Executing jpackage command..."
          echo "Command: $JPACKAGE_CMD"
          
          JPACKAGE_OUTPUT=$(eval $JPACKAGE_CMD --verbose 2>&1)
          APP_IMAGE_EXIT_CODE=$?
          
          echo "jpackage exit code: $APP_IMAGE_EXIT_CODE"
          echo "jpackage output:"
          echo "$JPACKAGE_OUTPUT"
          
          if [ $APP_IMAGE_EXIT_CODE -eq 0 ]; then
            echo "✅ JavaFxEditor app-image created successfully"
            
            # Check if app-image was created (macOS uses .app, Linux uses directory)
            APP_IMAGE_PATH=""
            if [ -d "release-assets/native-$PLATFORM/JavaFxEditor.app" ]; then
              APP_IMAGE_PATH="release-assets/native-$PLATFORM/JavaFxEditor.app"
            elif [ -d "release-assets/native-$PLATFORM/JavaFxEditor" ]; then
              APP_IMAGE_PATH="release-assets/native-$PLATFORM/JavaFxEditor"
            fi
            
            if [ -n "$APP_IMAGE_PATH" ]; then
              echo "App-image found at: $APP_IMAGE_PATH"
              echo "Converting to $PKG_TYPE..."
              
              # Convert app-image to package
              if [ "$PKG_TYPE" != "app-image" ]; then
                # Build conversion command
                CONVERT_CMD="jpackage \
                  --app-image \"$APP_IMAGE_PATH\" \
                  --type \"$PKG_TYPE\" \
                  --dest release-assets/native-$PLATFORM \
                  --app-version \"$VERSION\""
                
                # macOS specific options for conversion
                if [ "$PLATFORM" = "macos" ]; then
                  CONVERT_CMD="$CONVERT_CMD --mac-sign false"
                fi
                
                echo "Converting app-image to $PKG_TYPE..."
                echo "Command: $CONVERT_CMD"
                
                JPACKAGE_OUTPUT2=$(eval $CONVERT_CMD --verbose 2>&1)
                PACKAGE_EXIT_CODE=$?
                echo "$JPACKAGE_OUTPUT2"
                
                if [ $PACKAGE_EXIT_CODE -eq 0 ]; then
                  echo "✅ JavaFxEditor $PKG_TYPE package created successfully"
                else
                  echo "⚠️ Failed to convert app-image to $PKG_TYPE, but app-image is available"
                fi
              fi
            else
              echo "⚠️ App-image directory not found after creation"
            fi
          else
            echo "❌ JavaFxEditor app-image creation failed with exit code $APP_IMAGE_EXIT_CODE"
            echo "Full output:"
            echo "$JPACKAGE_OUTPUT"
          fi
        else
          echo "⚠️ JavaFxEditor JAR file not found: JavaFxEditor/target/JavaFxEditor-$VERSION.jar"
        fi
        
        echo ""
        echo "=== Checking for generated packages ==="
        echo "Platform: $PLATFORM"
        echo "Package type: $PKG_TYPE"
        echo "Destination: release-assets/native-$PLATFORM"
        
        # Check if directory exists
        if [ -d "release-assets/native-$PLATFORM" ]; then
          echo "Directory exists. Listing contents:"
          ls -lah release-assets/native-$PLATFORM/ || echo "ls failed"
          
          # Find all files recursively
          echo ""
          echo "Finding all files:"
          find release-assets/native-$PLATFORM -type f || echo "No files found"
          
          # Count files
          FILE_COUNT=$(find release-assets/native-$PLATFORM -type f 2>/dev/null | wc -l || echo "0")
          echo "Total files found: $FILE_COUNT"
        else
          echo "⚠️ Directory does not exist: release-assets/native-$PLATFORM"
        fi
        
        # Also check if jpackage created files in a different location
        echo ""
        echo "Checking for files with package extensions in current directory:"
        find . -maxdepth 3 -type f \( -name "*.deb" -o -name "*.dmg" -o -name "*.msi" -o -name "*.exe" -o -name "*.pkg" -o -name "*.AppImage" \) 2>/dev/null | head -20 || echo "No package files found"
        
    - name: List generated packages
      shell: bash
      run: |
        PLATFORM="${{ matrix.platform-name }}"
        PKG_TYPE="${{ matrix.pkg-type }}"
        echo "=== Checking for generated packages ==="
        echo "Platform: $PLATFORM"
        echo "Package type: $PKG_TYPE"
        echo "Directory: release-assets/native-$PLATFORM"
        
        # Check target directory
        if [ -d "release-assets/native-$PLATFORM" ]; then
          echo "✅ Directory exists. Contents:"
          ls -lah release-assets/native-$PLATFORM/ || echo "ls failed"
          
          echo ""
          echo "Finding all files in directory:"
          find release-assets/native-$PLATFORM -type f || echo "find returned no files"
          
          # Check for specific package types
          echo ""
          echo "Looking for $PKG_TYPE files:"
          find release-assets/native-$PLATFORM -name "*.$PKG_TYPE" -o -name "*.$PKG_TYPE.*" 2>/dev/null || echo "No $PKG_TYPE files found"
        else
          echo "⚠️ Directory does not exist: release-assets/native-$PLATFORM"
        fi
        
        # Check if files were created in jpackage's default location
        echo ""
        echo "Checking jpackage default locations:"
        if [ "$PLATFORM" == "macos" ]; then
          # macOS might create .app bundles
          find . -maxdepth 3 -type d -name "*.app" 2>/dev/null | head -5 || echo "No .app bundles found"
        fi
        
        # Check current working directory
        echo ""
        echo "Current working directory: $(pwd)"
        echo "Files in current directory:"
        ls -la | head -10
        
    - name: Upload native packages to Release
      uses: softprops/action-gh-release@v1
      continue-on-error: true
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        files: |
          release-assets/native-${{ matrix.platform-name }}/*.deb
          release-assets/native-${{ matrix.platform-name }}/*.dmg
          release-assets/native-${{ matrix.platform-name }}/*.msi
          release-assets/native-${{ matrix.platform-name }}/*.exe
          release-assets/native-${{ matrix.platform-name }}/*.pkg
          release-assets/native-${{ matrix.platform-name }}/*.AppImage
        tag_name: ${{ github.ref_name }}
        fail_on_unmatched_files: false
