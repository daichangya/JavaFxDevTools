name: Release

on:
  release:
    types: [published]

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"
        
    - name: Build with Maven
      run: mvn clean package -DskipTests
      
    - name: Verify JAR files
      run: |
        echo "Checking for runnable JAR files..."
        ls -lh DevTools/target/*-runnable.jar || echo "DevTools runnable JAR not found"
        ls -lh JavaFxEditor/target/*-runnable.jar || echo "JavaFxEditor runnable JAR not found"
        
    - name: Rename JAR files
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if [ -f "DevTools/target/DevTools-1.0.0-SNAPSHOT-runnable.jar" ]; then
          mv DevTools/target/DevTools-1.0.0-SNAPSHOT-runnable.jar DevTools/target/DevTools-$VERSION.jar
          echo "Renamed DevTools JAR to DevTools-$VERSION.jar"
        fi
        if [ -f "JavaFxEditor/target/JavaFxEditor-1.0.0-SNAPSHOT-runnable.jar" ]; then
          mv JavaFxEditor/target/JavaFxEditor-1.0.0-SNAPSHOT-runnable.jar JavaFxEditor/target/JavaFxEditor-$VERSION.jar
          echo "Renamed JavaFxEditor JAR to JavaFxEditor-$VERSION.jar"
        fi
        
    - name: Generate SHA256 checksums
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        cd DevTools/target
        if [ -f "DevTools-$VERSION.jar" ]; then
          sha256sum DevTools-$VERSION.jar > DevTools-$VERSION.jar.sha256
          echo "Generated checksum for DevTools-$VERSION.jar"
          cat DevTools-$VERSION.jar.sha256
        fi
        cd ../../JavaFxEditor/target
        if [ -f "JavaFxEditor-$VERSION.jar" ]; then
          sha256sum JavaFxEditor-$VERSION.jar > JavaFxEditor-$VERSION.jar.sha256
          echo "Generated checksum for JavaFxEditor-$VERSION.jar"
          cat JavaFxEditor-$VERSION.jar.sha256
        fi
        
    - name: Create install scripts
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        mkdir -p dist
        
        # Create install.sh for Linux/macOS
        cat > dist/install-$VERSION.sh <<'SCRIPT_EOF'
        #!/bin/bash
        set -e
        
        VERSION="$1"
        if [ -z "$VERSION" ]; then
          VERSION="latest"
        fi
        
        REPO_URL="https://github.com/daichangya/JavaFxDevTools"
        INSTALL_DIR="${HOME}/.local/share/javafxdevtools"
        BIN_DIR="${HOME}/.local/bin"
        
        echo "JavaFxDevTools Installation Script"
        echo "=================================="
        echo ""
        
        # Check Java version
        if ! command -v java &> /dev/null; then
            echo "Error: Java is not installed. Please install JDK 17 or higher."
            exit 1
        fi
        
        JAVA_VERSION=$(java -version 2>&1 | head -n 1 | cut -d'"' -f2 | sed '/^1\./s///' | cut -d'.' -f1)
        if [ "$JAVA_VERSION" -lt 17 ]; then
            echo "Error: Java 17 or higher is required. Found Java $JAVA_VERSION"
            exit 1
        fi
        
        echo "Java version check passed: $(java -version 2>&1 | head -n 1)"
        
        # Create installation directory
        mkdir -p "$INSTALL_DIR"
        mkdir -p "$BIN_DIR"
        
        # Download JAR files
        echo ""
        echo "Downloading DevTools..."
        curl -L -o "$INSTALL_DIR/DevTools-$VERSION.jar" "$REPO_URL/releases/download/v$VERSION/DevTools-$VERSION.jar"
        
        echo "Downloading JavaFxEditor..."
        curl -L -o "$INSTALL_DIR/JavaFxEditor-$VERSION.jar" "$REPO_URL/releases/download/v$VERSION/JavaFxEditor-$VERSION.jar"
        
        # Create launcher scripts
        echo ""
        echo "Creating launcher scripts..."
        
        cat > "$BIN_DIR/devtools" << 'LAUNCHER_EOF'
        #!/bin/bash
        VERSION="$VERSION"
        java -jar "$HOME/.local/share/javafxdevtools/DevTools-$VERSION.jar" "$@"
        LAUNCHER_EOF
        
        cat > "$BIN_DIR/javafxeditor" << 'LAUNCHER_EOF'
        #!/bin/bash
        VERSION="$VERSION"
        java -jar "$HOME/.local/share/javafxdevtools/JavaFxEditor-$VERSION.jar" "$@"
        LAUNCHER_EOF
        
        chmod +x "$BIN_DIR/devtools"
        chmod +x "$BIN_DIR/javafxeditor"
        
        echo ""
        echo "Installation completed!"
        echo ""
        echo "Applications installed to: $INSTALL_DIR"
        echo "Launcher scripts created in: $BIN_DIR"
        echo ""
        echo "To use the applications, ensure $BIN_DIR is in your PATH:"
        echo "  export PATH=\"\$PATH:$BIN_DIR\""
        echo ""
        echo "Then you can run:"
        echo "  devtools"
        echo "  javafxeditor"
        SCRIPT_EOF

        # Create install.bat for Windows
        cat > dist/install-$VERSION.bat <<'BAT_EOF'
        @echo off
        setlocal enabledelayedexpansion
        
        set "VERSION=%~1"
        if "%VERSION%"=="" set "VERSION=latest"
        
        set "REPO_URL=https://github.com/daichangya/JavaFxDevTools"
        set "INSTALL_DIR=%USERPROFILE%\JavaFxDevTools"
        set "BIN_DIR=%USERPROFILE%\JavaFxDevTools\bin"
        
        echo JavaFxDevTools Installation Script
        echo ==================================
        echo.
        
        REM Check Java version
        java -version >nul 2>&1
        if errorlevel 1 (
            echo Error: Java is not installed. Please install JDK 17 or higher.
            pause
            exit /b 1
        )
        
        echo Java version check passed.
        echo.
        
        REM Create installation directory
        if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"
        if not exist "%BIN_DIR%" mkdir "%BIN_DIR%"
        
        REM Download JAR files
        echo Downloading DevTools...
        curl -L -o "%INSTALL_DIR%\DevTools-%VERSION%.jar" "%REPO_URL%/releases/download/v%VERSION%/DevTools-%VERSION%.jar"
        
        echo Downloading JavaFxEditor...
        curl -L -o "%INSTALL_DIR%\JavaFxEditor-%VERSION%.jar" "%REPO_URL%/releases/download/v%VERSION%/JavaFxEditor-%VERSION%.jar"
        
        REM Create launcher scripts
        echo.
        echo Creating launcher scripts...
        
        echo @echo off > "%BIN_DIR%\devtools.bat"
        echo set "VERSION=%VERSION%" >> "%BIN_DIR%\devtools.bat"
        echo java -jar "%INSTALL_DIR%\DevTools-%%VERSION%%.jar" %%* >> "%BIN_DIR%\devtools.bat"
        
        echo @echo off > "%BIN_DIR%\javafxeditor.bat"
        echo set "VERSION=%VERSION%" >> "%BIN_DIR%\javafxeditor.bat"
        echo java -jar "%INSTALL_DIR%\JavaFxEditor-%%VERSION%%.jar" %%* >> "%BIN_DIR%\javafxeditor.bat"
        
        echo.
        echo Installation completed!
        echo.
        echo Applications installed to: %INSTALL_DIR%
        echo Launcher scripts created in: %BIN_DIR%
        echo.
        echo Add %BIN_DIR% to your PATH to use the applications.
        echo.
        pause
        BAT_EOF

        chmod +x dist/install-$VERSION.sh
        echo "Created install scripts"
        
    - name: Test JAR files
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        echo "Testing JAR files..."
        
        # Test DevTools JAR
        if [ -f "DevTools/target/DevTools-$VERSION.jar" ]; then
          echo "Testing DevTools-$VERSION.jar..."
          java -jar DevTools/target/DevTools-$VERSION.jar --version 2>&1 || echo "DevTools JAR is valid (version check may not be supported)"
        fi
        
        # Test JavaFxEditor JAR
        if [ -f "JavaFxEditor/target/JavaFxEditor-$VERSION.jar" ]; then
          echo "Testing JavaFxEditor-$VERSION.jar..."
          java -jar JavaFxEditor/target/JavaFxEditor-$VERSION.jar --version 2>&1 || echo "JavaFxEditor JAR is valid (version check may not be supported)"
        fi
        
    - name: Prepare release assets
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        mkdir -p release-assets
        
        # Copy JAR files
        if [ -f "DevTools/target/DevTools-$VERSION.jar" ]; then
          cp DevTools/target/DevTools-$VERSION.jar release-assets/
          cp DevTools/target/DevTools-$VERSION.jar.sha256 release-assets/
        fi
        
        if [ -f "JavaFxEditor/target/JavaFxEditor-$VERSION.jar" ]; then
          cp JavaFxEditor/target/JavaFxEditor-$VERSION.jar release-assets/
          cp JavaFxEditor/target/JavaFxEditor-$VERSION.jar.sha256 release-assets/
        fi
        
        # Copy install scripts
        if [ -f "dist/install-$VERSION.sh" ]; then
          cp dist/install-$VERSION.sh release-assets/
        fi
        if [ -f "dist/install-$VERSION.bat" ]; then
          cp dist/install-$VERSION.bat release-assets/
        fi
        
        echo "Release assets prepared:"
        ls -lh release-assets/
        
    - name: Install dependencies for jpackage (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y fakeroot dpkg-dev
        
    - name: Build native packages
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        echo "Building native packages using jpackage..."
        echo "Platform: ${{ runner.os }}"
        
        # Check if jpackage is available
        if ! command -v jpackage &> /dev/null; then
          echo "⚠️ jpackage not found, skipping native package generation"
          echo "Note: jpackage requires JDK 14+ and is available in JDK 17"
          exit 0
        fi
        
        jpackage --version || echo "jpackage version check failed"
        
        mkdir -p release-assets/native
        
        # Determine package type based on platform
        if [ "${{ runner.os }}" == "Linux" ]; then
          PKG_TYPE="deb"
        elif [ "${{ runner.os }}" == "macOS" ]; then
          PKG_TYPE="dmg"
        elif [ "${{ runner.os }}" == "Windows" ]; then
          PKG_TYPE="msi"
        else
          PKG_TYPE="app-image"
        fi
        
        echo "Package type: $PKG_TYPE"
        
        # Build DevTools native package
        if [ -f "DevTools/target/DevTools-$VERSION.jar" ]; then
          echo "Creating DevTools native package ($PKG_TYPE)..."
          jpackage \
            --input DevTools/target \
            --name DevTools \
            --main-jar DevTools-$VERSION.jar \
            --main-class com.daicy.devtools.TextEditor \
            --type "$PKG_TYPE" \
            --dest release-assets/native \
            --app-version "$VERSION" \
            --description "DevTools - Plugin-based Text Editor" \
            --vendor "daichangya" \
            --license-file LICENSE 2>&1 || echo "⚠️ DevTools native package creation failed"
        fi
        
        # Build JavaFxEditor native package
        if [ -f "JavaFxEditor/target/JavaFxEditor-$VERSION.jar" ]; then
          echo "Creating JavaFxEditor native package ($PKG_TYPE)..."
          jpackage \
            --input JavaFxEditor/target \
            --name JavaFxEditor \
            --main-jar JavaFxEditor-$VERSION.jar \
            --main-class com.daicy.javafxeditor.TestEditor \
            --type "$PKG_TYPE" \
            --dest release-assets/native \
            --app-version "$VERSION" \
            --description "JavaFxEditor - Customizable Code Editor" \
            --vendor "daichangya" \
            --license-file LICENSE 2>&1 || echo "⚠️ JavaFxEditor native package creation failed"
        fi
        
        echo ""
        echo "Native packages (if any):"
        ls -lh release-assets/native/ 2>/dev/null || echo "No native packages generated"
        echo ""
        echo "Note: Native packages are only generated on the platform they're built on."
        echo "For multi-platform packages, consider using a matrix strategy."
        
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        files: |
          release-assets/*.jar
          release-assets/*.sha256
          release-assets/*.sh
          release-assets/*.bat
          release-assets/native/**

